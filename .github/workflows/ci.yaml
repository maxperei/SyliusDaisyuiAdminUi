name: ci

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
  phpunit:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php: [ "8.2", "8.3" ]
        symfony: [ "^6.4", "^7.4" ]
        include:
          - php: '8.1'
            symfony: "^6.4"
          - php: '8.4'
            symfony: "^7.4"
          - php: '8.4'
            symfony: "^8.0"
    name: "PHP ${{ matrix.php }} / Symfony ${{ matrix.symfony }}"
    env:
        APP_ENV: test
        COMPOSER_ROOT_VERSION: "dev-main"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: 'symfony, composer:v2, flex'
          coverage: none

      - name: Shutdown default MySQL
        run: sudo service mysql stop

      - name: Restrict packages' versions
        run: composer config extra.symfony.require "${{ matrix.symfony }}"

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ github.run_id }}-${{ runner.os }}-${{ hashFiles('composer.json') }}-symfony-${{ matrix.symfony }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer update --no-interaction --no-scripts

      - name: Validate composer.json
        run: composer validate --strict --no-check-version

      - name: Check for security vulnerabilities
        run: symfony security:check

      - name: Install assets to test application directory
        run: |
          cd tests/Functional/.application
          bin/console importmap:install
          bin/console tailwind:build ../../../assets/styles/syliusdaisyuiadminui.css
          bin/console asset-map:compile

      - name: Run tests
        run: vendor/bin/phpunit

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: panther-screenshots
          path: tests/Functional/.application/var/error-screenshots/
          retention-days: 1
